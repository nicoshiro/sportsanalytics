---
title: "hier_clustering_analysis"
author: "Isys"
date: "6/4/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Including Plots
library(cluster)
library(factoextra)
library(gmodels)
library(descr)
library(dplyr)
library(tidyr)
library(stargazer)

setwd("/Users/isysjo/Documents/Summer REU 2018/SportsAnalytics/R")


# new data
clean_individual_player_data <- function(player_table) {
  player_table <- player_table %>%
    filter(MIN > 0)
  return(player_table)
}

# modifications to load all players
path_to_files <- '../Data/2017_2018/'
filelist = paste0(path_to_files, list.files(path_to_files, 'all_per_minute_2017_2018.csv'))
all_players <- read.csv(filelist)


clean_load <- all_players %>% clean_individual_player_data()

# get aggregate player data
 aggregate_players <- clean_load 

# remove players who haven't played more than 50 minutes
aggregate_players <- aggregate_players %>% filter(MIN > 50)

# get numeric data (excluding result, GS, MP, and GmSc)
numeric <- aggregate_players %>% select(FGM:BOX_OUTS, -POS)



### 2015-2016 data exploration

#source('preprocess_individuals.R')


# get aggregate player data
#aggregate_players <- get_aggregate_players()

# make a copy of detailed positions
#aggregate_players <- aggregate_players %>% mutate(PosDetail = Pos)

# group regular positions
#levels(aggregate_players$Pos) <- c('Center',
#                                   'Center',
#                                   'Forward',
#                                   'Forward',
#                                   'Forward',
#                                   'Guard',
#                                   'Guard')

# remove players who haven't played more than 50 minutes
#aggregate_players <- aggregate_players %>% filter(MP > 50)

# get numeric data (excluding result, GS, MP, and GmSc)
#numeric <- aggregate_players %>% select(FG:PTS)

# set NA percentages to 0
numeric[is.na(numeric)] <- 0

# scale numeric data before clustering
numeric_scaled <- scale(numeric)

# agglomerative clustering method (nesting)
agg <- agnes(numeric_scaled, method= "complete")
plot(agg)

# default agglomerative clustering method
km.res <- hclust(dist(numeric_scaled), "complete")
plot(km.res)

#divisive clustering method
dian <- diana(numeric_scaled)
plot(dian)

# finding optimal cluster numbers for hierarchal clustering
fviz_nbclust(numeric_scaled, hcut, method = "wss")
fviz_nbclust(numeric_scaled, hcut, method = "silhouette")
fviz_nbclust(numeric_scaled, hcut, method = "gap_stat")
# should do the same thing but by consensus, but i have problems getting this one to work
# nb <- NbClust(numeric_scaled.num, diss.t, distance = NULL, min.nc = 2,
#              max.nc = 15, method = "complete")

# show them as tables
table_agg2 <- table(cutree(agg,6))
table_agg <- table(cutree(agg,3))
table_diana <- table(cutree(dian,3))
table_diana2 <- table(cutree(dian,4))

# mark each with their assigned cluster for each hierarchal clustering method
clusters_added_agg <- cbind(aggregate_players, cluster = cutree(agg,3))
#clusters_added_hclust <- cbind(aggregate_players, cluster = cutree(km.res,3))
clusters_added_diana <- cbind(aggregate_players, cluster = cutree(dian,3))

# plot them by PCA dimensions and color code by cluster
pca <- PCA(numeric_scaled)
plot(pca, choix = "ind",col.ind=ifelse(clusters_added_agg$cluster ==1, "red", ifelse(clusters_added_agg$cluster ==2, "blue", ifelse(clusters_added_agg$cluster ==4, "green", "black"))), label = "none")

plot(pca, choix = "ind",col.ind=ifelse(clusters_added_diana$cluster ==1, "red", ifelse(clusters_added_diana$cluster ==2, "blue", ifelse(clusters_added_diana$cluster ==4, "green", "black"))), label = "none")

## doing PCA and the clustering and color coding based on components
pca_coord <- pca$ind$coord
pca_coord[is.na(pca_coord)] <- 0
pca_coord_scaled <- scale(pca_coord)

diana_pca <- diana(pca_coord_scaled)
agg_pca <- agnes(pca_coord_scaled)
#   get optimal number of clusters
fviz_nbclust(pca_coord_scaled, hcut, method = "wss")
fviz_nbclust(pca_coord_scaled, hcut, method = "silhouette")
fviz_nbclust(pca_coord_scaled, hcut, method = "gap_stat")

table_agg_pca <- table(cutree(agg_pca,4))
table_diana_pca <- table(cutree(diana_pca,6))

clusters_added_PCA_D <- as.data.frame(cbind(pca_coord_scaled, cluster = cutree(diana_pca,6)))
#clusters_added_PCA_A <- cbind(pca_coord_scaled, cluster = cutree(agg_pca,3))

plot(pca, choix = "ind",col.ind=ifelse(clusters_added_PCA_D$cluster ==1, "red",
  ifelse(clusters_added_PCA_D$cluster ==2, "blue", 
    ifelse(clusters_added_PCA_D$cluster ==3, "green", 
      ifelse(clusters_added_PCA_D$cluster ==4, "purple", 
        ifelse(clusters_added_PCA_D$cluster ==5,"black", "orange"))))), label = "none")
        


# make table for position breakdown in each cluster
ct <- gmodels::CrossTable(clusters_added_diana$POS, clusters_added_diana$cluster,
                 prop.r = TRUE, prop.c = TRUE, prop.t=FALSE, prop.chisq = FALSE)
#ctdetail <- CrossTable(clusters_added_diana$PosDetail, clusters_added_diana$cluster,
#                       prop.r = TRUE, prop.c = FALSE, prop.t=FALSE, prop.chisq = FALSE)



# turn simple crosstable row proportions into latex
row.props <- data.frame(ct$prop.row) %>%
  spread(key = y, value = Freq)
names(row.props) <- c('Position', 'Cluster 1', 'Cluster 2', 'Cluster 3')
row.props <- as.matrix(row.props)
for (colnum in 2:(num_clusters+1)) {
  row.props[,colnum] <- round(as.numeric(row.props[,colnum]), 3)
}


col.props <- data.frame(ct$prop.col) %>%
  spread(key = y, value = Freq)
names(col.props) <- c('Position', 'Cluster 1', 'Cluster 2', 'Cluster 3')
col.props <- as.matrix(col.props)
for (colnum in 2:(num_clusters+1)) {
  col.props[,colnum] <- round(as.numeric(col.props[,colnum]), 3)
}


# print as latex
stargazer(row.props, type = 'latex')

# turn detailed crosstable row proportions into latex
row.props <- data.frame(ctdetail$prop.row) %>%
  spread(key = y, value = Freq)
names(row.props) <- c('Position', 'Cluster 1', 'Cluster 2', 'Cluster 3')
row.props <- as.matrix(row.props)
for (colnum in 2:(num_clusters+1)) {
  row.props[,colnum] <- round(as.numeric(row.props[,colnum]), 3)
}
# print as latex
stargazer(row.props, type = 'latex')
```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
